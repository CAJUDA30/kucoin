name: Test Secrets Configuration

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:  # Also allow manual trigger

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check AWS Secrets
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "âœ“ AWS_ACCESS_KEY_ID is set: ${AWS_ACCESS_KEY_ID:0:10}..."
          echo "âœ“ AWS_SECRET_ACCESS_KEY is set: ${AWS_SECRET_ACCESS_KEY:0:10}..."
          echo "âœ“ AWS_REGION is set: $AWS_REGION"
          
      - name: Check EC2 Secrets
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "âœ“ EC2_HOST is set: $EC2_HOST"
          echo "âœ“ EC2_USER is set: $EC2_USER"
          if [ -n "$EC2_SSH_KEY" ]; then
            echo "âœ“ EC2_SSH_KEY is set (length: ${#EC2_SSH_KEY} chars)"
          else
            echo "âœ— EC2_SSH_KEY is NOT set"
            exit 1
          fi
          
      - name: Test AWS CLI with credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Verify AWS access
        run: |
          echo "Testing AWS CLI access..."
          aws sts get-caller-identity
          echo "âœ“ AWS credentials are valid!"
          
      - name: Test SSH key format
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > test_key.pem
          chmod 600 test_key.pem
          if ssh-keygen -l -f test_key.pem; then
            echo "âœ“ SSH key format is valid!"
          else
            echo "âœ— SSH key format is INVALID"
            exit 1
          fi
          rm -f test_key.pem
          
      - name: Test EC2 connectivity
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          echo "Testing SSH connection to EC2..."
          if ssh -i private_key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo 'âœ“ SSH connection successful!'; uname -a"; then
            echo "âœ“ EC2 connection is working!"
          else
            echo "âœ— EC2 connection FAILED"
            exit 1
          fi
          
          rm -f private_key.pem
          
      - name: Summary
        run: |
          echo "================================================"
          echo "âœ… All secrets are configured correctly!"
          echo "================================================"
          echo ""
          echo "Verified:"
          echo "  âœ“ AWS_ACCESS_KEY_ID"
          echo "  âœ“ AWS_SECRET_ACCESS_KEY"
          echo "  âœ“ AWS_REGION"
          echo "  âœ“ EC2_HOST"
          echo "  âœ“ EC2_USER"
          echo "  âœ“ EC2_SSH_KEY"
          echo "  âœ“ AWS CLI authentication"
          echo "  âœ“ SSH key format"
          echo "  âœ“ EC2 connectivity"
          echo ""
          echo "ðŸš€ Ready for deployment!"

